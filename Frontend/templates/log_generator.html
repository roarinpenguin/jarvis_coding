<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthetic Log Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <script src="{{ url_for('static', filename='js/token_vault.js') }}"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #110e19;
            color: #d1b8e8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            flex-grow: 1;
        }
        .top-nav {
            background: rgba(26, 22, 41, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            margin-bottom: 2rem;
            padding: 0.75rem 0;
            position: relative;
        }
        .nav-toggle {
            background: transparent;
            border: none;
            color: #a78bfa;
            cursor: pointer;
            padding: 0.5rem 1rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto;
            transition: all 0.3s ease;
        }
        .nav-toggle:hover {
            color: #c4b5fd;
            transform: scale(1.05);
        }
        .nav-toggle-icon {
            transition: transform 0.3s ease;
        }
        .nav-toggle.active .nav-toggle-icon {
            transform: rotate(180deg);
        }
        .nav-toggle-text {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-tabs {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            max-width: 600px;
            margin: 1rem auto 0;
            padding-top: 1rem;
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }
        .nav-tabs.active {
            display: flex;
        }
        .nav-tab {
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.5rem;
            border-radius: 1rem;
            min-width: 100px;
        }
        .nav-tab:hover {
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }
        .nav-tab.active {
            background: rgba(139, 92, 246, 0.15);
        }
        .nav-tab-icon {
            font-size: 1.75rem;
            transition: all 0.3s ease;
            filter: grayscale(0.7) opacity(0.6);
        }
        .nav-tab.active .nav-tab-icon {
            filter: grayscale(0) opacity(1);
            transform: scale(1.1);
        }
        .nav-tab:hover .nav-tab-icon {
            filter: grayscale(0) opacity(0.9);
        }
        .nav-tab-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #8b7a9f;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-tab.active .nav-tab-label {
            color: #a78bfa;
        }
        .nav-tab:hover .nav-tab-label {
            color: #b8a0d2;
        }
        .flow-panel {
            background: linear-gradient(135deg, #2a2342, #1f1a30);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid #3c325c;
            height: 100%;
        }
        .flow-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #8b5cf6;
            font-weight: 700;
            margin-bottom: 0.75rem;
            display: block;
        }
        .card {
            background: linear-gradient(135deg, #2a2342, #1f1a30);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid #3c325c;
        }
        .input-group select,
        .input-group input {
            background-color: #3c325c;
            color: #f3e8ff;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease-in-out;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            width: 100%;
        }
        .input-group label { display: block; margin-bottom: 0.25rem; }
        .input-group { min-width: 0; }
        .input-group select:focus,
        .input-group input:focus {
            outline: none;
            background-color: #4a416e;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.4);
        }
        .btn {
            background: linear-gradient(45deg, #a78bfa, #8b5cf6);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            border: none;
        }
        .btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #8b5cf6, #a78bfa);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
            transform: translateY(-2px);
        }
        .btn:disabled {
            background-color: #3c325c;
            color: #6c5f87;
            cursor: not-allowed;
            box-shadow: none;
        }
        #output-box, #scenario-output-box {
            background-color: #1a1629;
            border-radius: 0.75rem;
            padding: 1.5rem;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #3c325c;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .footer {
            margin-top: auto;
            text-align: center;
            padding: 1rem;
            color: #6c5f87;
        }
        .footer .heart-icon {
            color: #a78bfa;
            font-size: 1.25rem;
        }
        h1, h2, p {
            color: #f3e8ff;
        }
    </style>
</head>
<body>

<div class="container py-6">
    <!-- Top Navigation -->
    <nav class="top-nav">
        <button class="nav-toggle" id="nav-toggle">
            <span class="nav-toggle-icon">‚ò∞</span>
            <span class="nav-toggle-text">Menu</span>
        </button>
        <div class="nav-tabs" id="nav-tabs">
            <button type="button" data-target="generate-section" class="nav-tab active">
                <div class="nav-tab-icon">üìä</div>
                <div class="nav-tab-label">Generate</div>
            </button>
            <button type="button" data-target="scenarios-section" class="nav-tab">
                <div class="nav-tab-icon">üéØ</div>
                <div class="nav-tab-label">Scenarios</div>
            </button>
            <button type="button" data-target="upload-section" class="nav-tab">
                <div class="nav-tab-icon">üì§</div>
                <div class="nav-tab-label">Upload</div>
            </button>
            <button type="button" data-target="settings-section" class="nav-tab">
                <div class="nav-tab-icon">‚öôÔ∏è</div>
                <div class="nav-tab-label">Settings</div>
            </button>
        </div>
    </nav>

    <!-- Three Column Flow Layout -->
    <div id="generate-section" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- LEFT: Source Selection -->
        <div class="lg:col-span-3">
            <div class="flow-panel space-y-4">
                <span class="flow-label">‚ë† Source</span>
                <div class="input-group">
                    <label for="script" class="text-sm font-semibold text-[#c8b3e8]">Log Source</label>
                    <select id="script" name="script" required>
                        <option value="" disabled selected>Loading scripts...</option>
                    </select>
                </div>
                <p class="text-xs text-[#b8a0d2] mt-2">Select the security product to generate events from</p>
            </div>
        </div>

        <!-- MIDDLE: Data Options & Output -->
        <div class="lg:col-span-6">
            <div class="flow-panel space-y-6">
                <span class="flow-label">‚ë° Data Options & Output</span>
                
                <form id="log-form" class="space-y-6">
                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                        <input type="checkbox" id="continuous-mode" style="width: auto;">
                        <span>Continuous Mode (run until stopped)</span>
                    </label>
                    <label id="speed-mode-container" style="display: none; align-items: center; gap: 8px; margin-top: 8px; margin-left: 24px;">
                        <input type="checkbox" id="speed-mode" style="width: auto;">
                        <span>Speed Mode (pre-generate 1K events, loop for max throughput)</span>
                    </label>
                    <p class="text-xs text-[#b8a0d2] mt-1">When enabled, logs will generate continuously until stopped</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="log-count" class="text-sm font-semibold text-[#c8b3e8]">Number of Events</label>
                            <input type="number" id="log-count" name="log-count" value="10" min="1" required>
                        </div>

                        <div class="input-group">
                            <label for="eps" class="text-sm font-semibold text-[#c8b3e8]">Events Per Second (EPS)</label>
                            <input type="number" id="eps" name="eps" value="10" min="0.1" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div class="md:col-span-3 input-group">
                            <label for="metadata-fields" class="text-sm font-semibold text-[#c8b3e8]">Metadata Fields (Optional)</label>
                            <input type="text" id="metadata-fields" name="metadata-fields" placeholder='{"scenario.trace_id":"abc-123","environment":"test"}'>
                            <p class="text-xs text-[#b8a0d2] mt-1">Add custom fields to all events as JSON object (e.g., scenario.trace_id, environment, etc.)</p>
                        </div>
                        <div class="flex items-end">
                            <button type="button" id="gen-metadata-guid" class="btn" style="width:auto; padding:0.6rem 1rem;">Generate Trace ID</button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" id="start-btn" class="btn flex-1">
                            Start Log Generation
                        </button>
                        <button type="button" id="stop-btn" class="btn bg-red-600 hover:bg-red-700" style="display: none;">
                            Stop Generation
                        </button>
                    </div>
                </form>

                <div>
                    <h3 class="text-lg font-bold mb-3 text-[#f3e8ff]">Log Output</h3>
                    <div id="output-box">
                        <!-- Log messages will be streamed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Destination -->
        <div class="lg:col-span-3">
            <div class="flow-panel space-y-4" id="events-destination-panel">
                <span class="flow-label">‚ë¢ Destination</span>
                <div id="destination-selector-container">
                    <div class="input-group">
                        <label for="destination-select" class="text-sm font-semibold text-[#c8b3e8]">Select Destination</label>
                        <select id="destination-select" name="destination-select">
                            <option value="" disabled selected>Loading...</option>
                        </select>
                    </div>
                    <p class="text-xs text-[#b8a0d2] mt-2">Add or manage destinations in Settings</p>
                </div>
            </div>
        </div>
    </div>

    <div id="scenarios-section" class="grid grid-cols-1 lg:grid-cols-12 gap-6" style="display:none;">
        <!-- LEFT: Scenario Selection -->
        <div class="lg:col-span-3">
            <div class="flow-panel space-y-4">
                <span class="flow-label">‚ë† Scenario</span>
                <div class="input-group">
                    <label for="scenario-select" class="text-sm font-semibold text-[#c8b3e8]">Select Attack Scenario</label>
                    <select id="scenario-select" name="scenario-select" required>
                        <option value="" disabled selected>Loading scenarios...</option>
                    </select>
                </div>
                
                <div id="scenario-details" class="space-y-3" style="display:none;">
                    <h4 class="text-base font-bold text-[#f3e8ff]" id="scenario-name"></h4>
                    <p class="text-xs text-[#b8a0d2]" id="scenario-description"></p>
                    <div class="space-y-2 text-xs">
                        <div>
                            <span class="font-semibold text-[#c8b3e8]">Events:</span>
                            <span class="text-[#f3e8ff]" id="scenario-events"></span>
                        </div>
                        <div>
                            <span class="font-semibold text-[#c8b3e8]">Duration:</span>
                            <span class="text-[#f3e8ff]" id="scenario-duration"></span>
                        </div>
                        <div>
                            <span class="font-semibold text-[#c8b3e8] block mb-1">Attack Phases:</span>
                            <ul id="scenario-phases" class="list-disc list-inside text-[#b8a0d2]"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIDDLE: Options & Output -->
        <div class="lg:col-span-6">
            <div class="flow-panel space-y-6">
                <span class="flow-label">‚ë° Options & Output</span>
                
                <form id="scenario-form" class="space-y-6">
                    <div class="input-group">
                        <label for="worker-count" class="text-sm font-semibold text-[#c8b3e8]">Parallel Workers (EPS Boost)</label>
                        <input type="number" id="worker-count" name="worker-count" value="10" min="1" max="50" required>
                        <p class="text-xs text-[#b8a0d2] mt-1">More workers = Higher throughput (default: 10)</p>
                    </div>

                    <details class="bg-[#241d3a] rounded-lg p-3 border border-[#3c325c]">
                        <summary class="cursor-pointer text-sm font-semibold text-[#c8b3e8]">Metadata Options</summary>
                        <div class="mt-3 space-y-2 text-sm">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="include-phase-tag" checked>
                                <span class="text-[#f3e8ff]">Include <code>scenario.phase</code> tag for tracking</span>
                            </label>
                            <p class="text-xs text-[#b8a0d2]">Uncheck to disable adding the <code>scenario.phase</code> attribute on events sent to HEC.</p>
                            <div class="mt-3 pt-3 border-t border-[#3c325c] space-y-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="include-trace-id" checked>
                                    <span class="text-[#f3e8ff]">Attach <code>scenario.trace_id</code> to every event</span>
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="md:col-span-2 input-group">
                                        <label for="trace-id" class="text-sm font-semibold text-[#c8b3e8]">Trace ID (GUID)</label>
                                        <input type="text" id="trace-id" placeholder="e.g. 3f2504e0-4f89-11d3-9a0c-0305e82c3301">
                                    </div>
                                    <div class="flex items-end">
                                        <button type="button" id="gen-trace-id" class="btn" style="width:auto; padding:0.6rem 1rem;">Generate</button>
                                    </div>
                                </div>
                                <p class="text-xs text-[#b8a0d2]">If blank, a GUID can be auto-generated. Use this value to correlate the full run.</p>
                            </div>
                        </div>
                    </details>

                    <details class="bg-[#241d3a] rounded-lg p-3 border border-[#3c325c]">
                        <summary class="cursor-pointer text-sm font-semibold text-[#c8b3e8]">Background Noise Options</summary>
                        <div class="mt-3 space-y-2 text-sm">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="generate-noise">
                                <span class="text-[#f3e8ff]">Generate background noise data</span>
                            </label>
                            <p class="text-xs text-[#b8a0d2]">Generates realistic activity from other users during the same 8-day window. 70% during business hours (8 AM - 5 PM EST), 30% off-hours.</p>
                            <div class="mt-3 input-group">
                                <label for="noise-events-count" class="text-sm font-semibold text-[#c8b3e8]">Total Noise Events</label>
                                <input type="number" id="noise-events-count" value="1200" min="100" max="1000000" step="100">
                                <p class="text-xs text-[#b8a0d2] mt-1">Recommended: 1200 events (400 per source: Okta, Azure AD, M365). Max: 1M events.</p>
                            </div>
                        </div>
                    </details>

                    <button type="submit" id="run-scenario-btn" class="btn">
                        Run Scenario
                    </button>
                </form>

                <div>
                    <h3 class="text-lg font-bold mb-3 text-[#f3e8ff]">Scenario Output</h3>
                    <div id="scenario-output-box">
                        <!-- Scenario progress will be streamed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Destination (shared selector) -->
        <div class="lg:col-span-3">
            <div class="flow-panel space-y-4" id="scenario-destination-panel">
                <span class="flow-label">‚ë¢ Destination</span>
                <!-- Destination selector will be moved here dynamically -->
            </div>
        </div>
    </div>

    <div id="upload-section" class="grid grid-cols-1 lg:grid-cols-12 gap-6" style="display:none;">
        <!-- LEFT: Upload Panel -->
        <div class="lg:col-span-3">
            <div class="flow-panel space-y-4">
                <span class="flow-label">‚ë† Upload File</span>
                <div id="upload-dropzone" style="border: 2px dashed #8b5cf6; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                    <div style="margin-bottom: 1rem; font-size: 3rem;">üìÅ</div>
                    <p class="text-sm font-semibold text-[#c8b3e8] mb-2">Drag & Drop File Here</p>
                    <p class="text-xs text-[#b8a0d2] mb-3">or click to browse</p>
                    <p class="text-xs text-[#8b7a9f]">CSV, JSON, TXT, LOG, or GZ files (max 1GB)</p>
                    <input type="file" id="file-input" accept=".csv,.json,.txt,.log,.gz" style="display: none;">
                </div>
                
                <div id="uploaded-files-list" class="space-y-2" style="display:none;">
                    <h4 class="text-sm font-semibold text-[#c8b3e8]">Uploaded Files</h4>
                    <div id="files-container"></div>
                </div>
            </div>
        </div>

        <!-- MIDDLE: Options & Output -->
        <div class="lg:col-span-6">
            <div class="flow-panel space-y-6">
                <span class="flow-label">‚ë° Processing Options & Output</span>
                
                <form id="upload-process-form" class="space-y-6">
                    <div class="input-group">
                        <label for="upload-file-select" class="text-sm font-semibold text-[#c8b3e8]">Select File</label>
                        <select id="upload-file-select" name="upload-file-select" required>
                            <option value="" disabled selected>No files uploaded</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="upload-sourcetype" class="text-sm font-semibold text-[#c8b3e8]">Sourcetype / Parser</label>
                        <input type="text" id="upload-sourcetype" name="upload-sourcetype" placeholder="e.g. aws_cloudtrail, fortinet_fortigate_logs" required>
                        <p class="text-xs text-[#b8a0d2] mt-1">Specify the sourcetype for HEC parsing</p>
                    </div>

                    <div class="input-group">
                        <label for="upload-endpoint" class="text-sm font-semibold text-[#c8b3e8]">HEC Endpoint</label>
                        <select id="upload-endpoint" name="upload-endpoint" required>
                            <option value="event" selected>Event Endpoint (JSON structured)</option>
                            <option value="raw">Raw Endpoint (Text/Syslog)</option>
                        </select>
                        <p class="text-xs text-[#b8a0d2] mt-1">/event for JSON, /raw for text logs</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="upload-batch-size" class="text-sm font-semibold text-[#c8b3e8]">Batch Size</label>
                            <input type="number" id="upload-batch-size" name="upload-batch-size" value="100" min="1" max="1000" required>
                            <p class="text-xs text-[#b8a0d2] mt-1">Events per batch (1-1000)</p>
                        </div>

                        <div class="input-group">
                            <label for="upload-eps" class="text-sm font-semibold text-[#c8b3e8]">Events Per Second (EPS)</label>
                            <input type="number" id="upload-eps" name="upload-eps" value="10" min="0.1" step="0.1" required>
                        </div>
                    </div>

                    <button type="submit" id="process-upload-btn" class="btn">
                        Process File
                    </button>
                </form>

                <div>
                    <h3 class="text-lg font-bold mb-3 text-[#f3e8ff]">Processing Output</h3>
                    <div id="upload-output-box" style="background-color: #1a1629; border-radius: 0.75rem; padding: 1.5rem; min-height: 200px; max-height: 500px; overflow-y: auto; border: 1px solid #3c325c; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); font-size: 0.875rem; line-height: 1.5;">
                        <!-- Processing output will be streamed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Destination (shared selector) -->
        <div class="lg:col-span-3">
            <div class="flow-panel space-y-4" id="upload-destination-panel">
                <span class="flow-label">‚ë¢ Destination</span>
                <!-- Destination selector will be moved here dynamically -->
            </div>
        </div>
    </div>

            <div id="settings-section" class="card space-y-4" style="display:none;">
                <h2 class="text-2xl font-bold text-[#f3e8ff]">Settings</h2>
                <div class="space-y-3">
                    <h3 class="text-xl font-bold text-[#f3e8ff]">Destinations</h3>
                    <form id="destinations-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label for="dest-type" class="text-sm font-semibold text-[#c8b3e8]">Type</label>
                            <select id="dest-type" name="dest-type" required>
                                <option value="hec" selected>HEC</option>
                                <option value="syslog">Syslog</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="dest-name" class="text-sm font-semibold text-[#c8b3e8]">Name</label>
                            <input type="text" id="dest-name" name="dest-name" placeholder="US1 Ingest" maxlength="40" required>
                        </div>
                        <div id="hec-config" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="input-group md:col-span-2">
                                <label for="dest-url" class="text-sm font-semibold text-[#c8b3e8]">HEC URL</label>
                                <input type="text" id="dest-url" name="dest-url" placeholder="https://ingest.us1.sentinelone.net" value="https://ingest.us1.sentinelone.net" required>
                            </div>
                            <div class="input-group md:col-span-3">
                                <label for="dest-token" class="text-sm font-semibold text-[#c8b3e8]">HEC API Key</label>
                                <div class="relative">
                                    <input type="password" id="dest-token" name="dest-token" autocomplete="off" placeholder="Paste token here" required class="pr-10">
                                    <button type="button" class="toggle-password absolute right-2 top-1/2 -translate-y-1/2 text-[#8b7a9f] hover:text-[#f3e8ff]" data-target="dest-token" style="background:none;border:none;cursor:pointer;">üëÅ</button>
                                </div>
                                <div class="mt-2">
                                    <label class="flex items-center gap-2 text-xs">
                                        <input type="checkbox" id="store-token-locally">
                                        <span class="text-[#b8a0d2]">Store token locally in browser (recommended for multi-user environments)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="md:col-span-3 mt-3 p-3 bg-[#241d3a] rounded-lg border border-[#3c325c]">
                                <div class="flex items-center gap-2 mb-2">
                                    <h4 class="text-sm font-semibold text-[#c8b3e8]">Parser Sync Configuration (Optional)</h4>
                                    <span class="text-xs text-[#8b7a9f]">For automatic parser upload</span>
                                </div>
                                <p class="text-xs text-[#b8a0d2] mb-3">These settings allow Jarvis to automatically check and upload required parsers to your AI SIEM before running scenarios.</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="input-group md:col-span-3">
                                        <label for="dest-config-api-url" class="text-sm font-semibold text-[#c8b3e8]">Config API URL</label>
                                        <input type="text" id="dest-config-api-url" name="dest-config-api-url" placeholder="https://xdr.us1.sentinelone.net">
                                        <p class="text-xs text-[#8b7a9f] mt-1">Different from ingest URL (e.g., xdr.us1 instead of ingest.us1)</p>
                                    </div>
                                    <div class="input-group">
                                        <label for="dest-config-read-token" class="text-sm font-semibold text-[#c8b3e8]">Config Read Token</label>
                                        <div class="relative">
                                            <input type="password" id="dest-config-read-token" name="dest-config-read-token" autocomplete="off" placeholder="For checking if parsers exist" class="pr-10">
                                            <button type="button" class="toggle-password absolute right-2 top-1/2 -translate-y-1/2 text-[#8b7a9f] hover:text-[#f3e8ff]" data-target="dest-config-read-token" style="background:none;border:none;cursor:pointer;">üëÅ</button>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="dest-config-write-token" class="text-sm font-semibold text-[#c8b3e8]">Config Write Token</label>
                                        <div class="relative">
                                            <input type="password" id="dest-config-write-token" name="dest-config-write-token" autocomplete="off" placeholder="For uploading missing parsers" class="pr-10">
                                            <button type="button" class="toggle-password absolute right-2 top-1/2 -translate-y-1/2 text-[#8b7a9f] hover:text-[#f3e8ff]" data-target="dest-config-write-token" style="background:none;border:none;cursor:pointer;">üëÅ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="syslog-config" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4" style="display:none;">
                            <div class="input-group">
                                <label for="dest-syslog-ip" class="text-sm font-semibold text-[#c8b3e8]">Syslog IP</label>
                                <input type="text" id="dest-syslog-ip" name="dest-syslog-ip" placeholder="127.0.0.1">
                            </div>
                            <div class="input-group">
                                <label for="dest-syslog-port" class="text-sm font-semibold text-[#c8b3e8]">Port</label>
                                <input type="number" id="dest-syslog-port" name="dest-syslog-port" placeholder="514" min="1" max="65535">
                            </div>
                            <div class="input-group">
                                <label for="dest-syslog-protocol" class="text-sm font-semibold text-[#c8b3e8]">Protocol</label>
                                <select id="dest-syslog-protocol" name="dest-syslog-protocol">
                                    <option value="UDP">UDP</option>
                                    <option value="TCP">TCP</option>
                                </select>
                            </div>
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit" class="btn">Save Destination</button>
                        </div>
                    </form>
                    <div>
                        <h4 class="text-lg font-semibold text-[#f3e8ff] mb-2">Saved Destinations</h4>
                        <ul id="destinations-list" class="space-y-2"></ul>
                        <template id="destination-item-template">
                            <li class="card p-3 flex items-center justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <span class="truncate dest-label"></span>
                                        <span class="token-indicator" style="display: none; font-size: 0.75rem; color: #10b981;" title="Token stored locally">üîí</span>
                                        <span class="parser-sync-indicator" style="display: none; font-size: 0.75rem; color: #60a5fa;" title="Parser sync tokens configured">üîÑ</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button type="button" class="edit-dest-btn" aria-label="Edit Destination" title="Edit Tokens" style="background: transparent; border: none; padding: 4px; cursor: pointer; color: #60a5fa;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="set-token-btn" aria-label="Set Local Token" title="Set Local Token" style="background: transparent; border: none; padding: 4px; cursor: pointer; color: #a78bfa; display: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="delete-dest" aria-label="Delete" title="Delete" style="background: transparent; border: none; padding: 4px; cursor: pointer; color: #f3e8ff;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="3 6 5 6 21 6" />
                                            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                            <path d="M10 11v6" />
                                            <path d="M14 11v6" />
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
                                        </svg>
                                    </button>
                                </div>
                            </li>
                        </template>
                    </div>
                    <div class="mt-4 p-3 bg-[#241d3a] rounded-lg border border-[#3c325c]">
                        <h4 class="text-sm font-semibold text-[#c8b3e8] mb-2">Local Token Storage</h4>
                        <p class="text-xs text-[#b8a0d2] mb-3">Tokens are encrypted and stored in your browser. Each user can have their own tokens.</p>
                        <button type="button" id="clear-all-tokens-btn" class="text-xs px-3 py-2 bg-red-900/30 hover:bg-red-900/50 border border-red-700 rounded text-red-300" style="transition: all 0.3s;">
                            Clear All Local Tokens
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Destination Modal -->
<div id="edit-dest-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center overflow-y-auto" style="display: none;">
    <div class="card max-w-2xl w-full mx-4 my-8 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-[#f3e8ff]">Edit Destination</h3>
            <button type="button" id="close-edit-modal" class="text-[#8b7a9f] hover:text-[#f3e8ff]" style="background: transparent; border: none; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form id="edit-dest-form" class="space-y-4">
            <input type="hidden" id="edit-dest-id">
            <input type="hidden" id="edit-dest-type">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="edit-dest-name-input" class="text-sm font-semibold text-[#c8b3e8]">Name</label>
                    <input type="text" id="edit-dest-name-input" placeholder="Destination name">
                </div>
                <div class="input-group" id="edit-url-group">
                    <label for="edit-dest-url" class="text-sm font-semibold text-[#c8b3e8]">HEC URL</label>
                    <input type="text" id="edit-dest-url" placeholder="https://ingest.us1.sentinelone.net">
                </div>
            </div>
            <div class="input-group" id="edit-token-group">
                <label for="edit-dest-token" class="text-sm font-semibold text-[#c8b3e8]">HEC Token</label>
                <div class="relative">
                    <input type="password" id="edit-dest-token" placeholder="Leave blank to keep existing" class="pr-10">
                    <button type="button" class="toggle-password absolute right-2 top-1/2 -translate-y-1/2 text-[#8b7a9f] hover:text-[#f3e8ff]" data-target="edit-dest-token" style="background:none;border:none;cursor:pointer;">üëÅ</button>
                </div>
            </div>
            <div class="p-3 bg-[#241d3a] rounded-lg border border-[#3c325c]" id="edit-parser-sync-group">
                <h4 class="text-sm font-semibold text-[#c8b3e8] mb-3">Parser Sync Configuration</h4>
                <div class="space-y-3">
                    <div class="input-group">
                        <label for="edit-config-api-url" class="text-sm font-semibold text-[#c8b3e8]">Config API URL</label>
                        <input type="text" id="edit-config-api-url" placeholder="https://xdr.us1.sentinelone.net">
                        <p class="text-xs text-[#8b7a9f] mt-1">Different from ingest URL (e.g., xdr.us1 instead of ingest.us1)</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="input-group">
                            <label for="edit-config-read-token" class="text-sm font-semibold text-[#c8b3e8]">Config Read Token</label>
                            <div class="relative">
                                <input type="password" id="edit-config-read-token" placeholder="Leave blank to keep existing" class="pr-10">
                                <button type="button" class="toggle-password absolute right-2 top-1/2 -translate-y-1/2 text-[#8b7a9f] hover:text-[#f3e8ff]" data-target="edit-config-read-token" style="background:none;border:none;cursor:pointer;">üëÅ</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="edit-config-write-token" class="text-sm font-semibold text-[#c8b3e8]">Config Write Token</label>
                            <div class="relative">
                                <input type="password" id="edit-config-write-token" placeholder="Leave blank to keep existing" class="pr-10">
                                <button type="button" class="toggle-password absolute right-2 top-1/2 -translate-y-1/2 text-[#8b7a9f] hover:text-[#f3e8ff]" data-target="edit-config-write-token" style="background:none;border:none;cursor:pointer;">üëÅ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="btn flex-1">Save Changes</button>
                <button type="button" id="cancel-edit-modal" class="flex-1 px-4 py-2 bg-[#3c325c] hover:bg-[#4a416e] rounded-lg text-[#f3e8ff] transition-all" style="border: none; cursor: pointer;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<footer class="footer">
    Made with <span class="heart-icon">‚ô°</span> by the RoarinPenguin
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        (async () => {
        // Navigation toggle
        const navToggle = document.getElementById('nav-toggle');
        const navTabs = document.getElementById('nav-tabs');
        
        navToggle.addEventListener('click', () => {
            navTabs.classList.toggle('active');
            navToggle.classList.toggle('active');
        });

        // Navigation tab switching
        const tabButtons = Array.from(document.querySelectorAll('.nav-tab'));
        const sections = {
            'generate-section': document.getElementById('generate-section'),
            'scenarios-section': document.getElementById('scenarios-section'),
            'upload-section': document.getElementById('upload-section'),
            'settings-section': document.getElementById('settings-section')
        };
        
        tabButtons.forEach(btn => btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const target = btn.dataset.target;
            Object.entries(sections).forEach(([id, el]) => {
                el.style.display = (id === target) ? '' : 'none';
            });
            
            // Auto-collapse menu after selection
            navTabs.classList.remove('active');
            navToggle.classList.remove('active');
            
            // Move destination selector to appropriate panel
            const destContainer = document.getElementById('destination-selector-container');
            const eventsPanel = document.getElementById('events-destination-panel');
            const scenarioPanel = document.getElementById('scenario-destination-panel');
            const uploadPanel = document.getElementById('upload-destination-panel');
            
            if (target === 'scenarios-section' && destContainer && scenarioPanel) {
                // Move to scenarios panel
                scenarioPanel.appendChild(destContainer);
            } else if (target === 'upload-section' && destContainer && uploadPanel) {
                // Move to upload panel
                uploadPanel.appendChild(destContainer);
            } else if (target === 'generate-section' && destContainer && eventsPanel) {
                // Move back to events panel
                eventsPanel.appendChild(destContainer);
            }
        }));

        const form = document.getElementById('log-form');
        const scriptSelect = document.getElementById('script');
        const startBtn = document.getElementById('start-btn');
        const outputBox = document.getElementById('output-box');

        async function fetchScripts() {
            try {
                // Trace options
                const tagPhase = document.getElementById('include-phase-tag')?.checked !== false;
                const tagTrace = document.getElementById('include-trace-id')?.checked !== false;
                let traceId = (document.getElementById('trace-id')?.value || '').trim();
                // Generate a GUID if requested/blank but trace tagging is enabled
                if (tagTrace && !traceId) {
                    // browser GUID
                    traceId = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                    );
                    const traceInput = document.getElementById('trace-id');
                    if (traceInput) traceInput.value = traceId;
                }
                const response = await fetch('/get-generators');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const payload = await response.json();
                const gens = payload.generators || [];

                // Group by category
                const byCategory = gens.reduce((acc, g) => {
                    const cat = g.category || 'Uncategorized';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(g);
                    return acc;
                }, {});

                scriptSelect.innerHTML = '';

                Object.keys(byCategory).sort().forEach(category => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    byCategory[category]
                        .sort((a,b) => a.name.localeCompare(b.name))
                        .forEach(g => {
                            const option = document.createElement('option');
                            // Use backend file_path for syslog; attach product id for HEC
                            option.value = g.file_path || g.id;
                            option.dataset.productId = g.id;
                            option.textContent = g.name || g.id;
                            optgroup.appendChild(option);
                        });
                    scriptSelect.appendChild(optgroup);
                });

                scriptSelect.disabled = gens.length === 0;
                if (gens.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'No generators available';
                    option.disabled = true;
                    scriptSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error fetching generators:', error);
                scriptSelect.innerHTML = '';
                const option = document.createElement('option');
                option.textContent = 'Error loading generators.';
                option.disabled = true;
                scriptSelect.appendChild(option);
            }
        }
        
        await fetchScripts();

        const destSelect = document.getElementById('destination-select');

        // Destinations management
        async function refreshDestinations() {
            try {
                const res = await fetch('/destinations');
                const data = await res.json();
                const allItems = (data.destinations || []);
                
                // Filter destinations: only show if user has access to them
                const items = allItems.filter(d => {
                    // Syslog destinations - always show (no tokens needed)
                    if (d.type === 'syslog') return true;
                    
                    // HEC destinations - check if user has access
                    if (d.type === 'hec') {
                        // Has local token? Always show
                        if (window.tokenVault && window.tokenVault.hasToken(d.id)) {
                            return true;
                        }
                        
                        // Has database token (not LOCAL_STORAGE)? Show
                        if (d.has_database_token === true) {
                            return true;
                        }
                        
                        // Neither local nor database token - hide it
                        return false;
                    }
                    
                    return true;
                });
                
                // Populate unified selector
                destSelect.innerHTML = '';
                if (items.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No destinations. Add in Settings.';
                    destSelect.appendChild(opt);
                } else {
                    // Group by type for readability
                    const grouped = items.reduce((acc, d) => {
                        (acc[d.type] = acc[d.type] || []).push(d);
                        return acc;
                    }, {});
                    ['hec', 'syslog'].forEach(type => {
                        if (!grouped[type] || grouped[type].length === 0) return;
                        const og = document.createElement('optgroup');
                        og.label = type.toUpperCase();
                        grouped[type].forEach((d, idx) => {
                            const opt = document.createElement('option');
                            opt.value = d.id;
                            opt.textContent = d.name;
                            opt.dataset.type = d.type;
                            if (destSelect.options.length === 0 && idx === 0) opt.selected = true;
                            og.appendChild(opt);
                        });
                        destSelect.appendChild(og);
                    });
                }
                // Populate list in settings
                const list = document.getElementById('destinations-list');
                if (list) {
                    list.innerHTML = '';
                    const tpl = document.getElementById('destination-item-template');
                    items.forEach(d => {
                        const node = tpl.content.firstElementChild.cloneNode(true);
                        node.querySelector('.dest-label').textContent = d.name;
                        
                        // Show lock icon if token is stored locally
                        const tokenIndicator = node.querySelector('.token-indicator');
                        if (d.type === 'hec' && window.tokenVault && window.tokenVault.hasToken(d.id)) {
                            tokenIndicator.style.display = 'inline';
                        }
                        
                        // Show parser sync indicator if config tokens are configured
                        const parserSyncIndicator = node.querySelector('.parser-sync-indicator');
                        if (d.has_config_read_token && d.has_config_write_token) {
                            parserSyncIndicator.style.display = 'inline';
                        }
                        
                        // Edit button for HEC destinations
                        const editBtn = node.querySelector('.edit-dest-btn');
                        if (d.type === 'hec') {
                            editBtn.addEventListener('click', () => {
                                document.getElementById('edit-dest-id').value = d.id;
                                document.getElementById('edit-dest-type').value = d.type;
                                document.getElementById('edit-dest-name-input').value = d.name;
                                document.getElementById('edit-dest-url').value = d.url || '';
                                document.getElementById('edit-dest-token').value = '';
                                document.getElementById('edit-config-api-url').value = d.config_api_url || '';
                                document.getElementById('edit-config-read-token').value = '';
                                document.getElementById('edit-config-write-token').value = '';
                                document.getElementById('edit-dest-modal').style.display = 'flex';
                            });
                        } else {
                            editBtn.style.display = 'none';
                        }
                        
                        // Show "Set Token" button for HEC destinations
                        const setTokenBtn = node.querySelector('.set-token-btn');
                        if (d.type === 'hec') {
                            setTokenBtn.style.display = 'block';
                            setTokenBtn.addEventListener('click', async () => {
                                const token = prompt(`Enter HEC token for "${d.name}":`);
                                if (!token || !token.trim()) return;
                                
                                // Ask where to store it
                                const storeLocal = confirm(
                                    'Where do you want to store this token?\n\n' +
                                    'OK = Store locally in browser (recommended for multi-user)\n' +
                                    'Cancel = Store in database (shared across browsers)'
                                );
                                
                                if (storeLocal) {
                                    // Store locally in browser
                                    await window.tokenVault.storeToken(d.id, token.trim());
                                    alert('‚úì Token stored locally in your browser');
                                } else {
                                    // Store in database
                                    try {
                                        const response = await fetch(`/destinations/${d.id}/update-token`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ token: token.trim() })
                                        });
                                        
                                        if (response.ok) {
                                            alert('‚úì Token stored in database');
                                        } else {
                                            throw new Error(`Server returned ${response.status}`);
                                        }
                                    } catch (err) {
                                        alert('‚úó Failed to store token in database. See console.');
                                        console.error(err);
                                        return;
                                    }
                                }
                                
                                await refreshDestinations();
                            });
                        }
                        
                        // Delete button
                        const delBtn = node.querySelector('.delete-dest');
                        delBtn.addEventListener('click', async () => {
                            if (!confirm(`Delete destination "${d.name}"?`)) return;
                            try {
                                const r = await fetch(`/destinations/${encodeURIComponent(d.id)}`, { method: 'DELETE' });
                                if (r.status !== 204) {
                                    const txt = await r.text();
                                    throw new Error(`Failed to delete (${r.status}): ${txt}`);
                                }
                                // Also remove local token if exists
                                if (window.tokenVault && window.tokenVault.hasToken(d.id)) {
                                    window.tokenVault.removeToken(d.id);
                                }
                                await refreshDestinations();
                            } catch (err) {
                                alert('Failed to delete destination. See console.');
                                console.error(err);
                            }
                        });
                        list.appendChild(node);
                    });
                }
            } catch (e) {
                console.error('Failed to load destinations', e);
            }
        }
        // Load destinations
        await refreshDestinations();

        const destForm = document.getElementById('destinations-form');
        const destTypeSel = document.getElementById('dest-type');
        const hecConfig = document.getElementById('hec-config');
        const syslogConfig = document.getElementById('syslog-config');
        function toggleDestConfig() {
            if (destTypeSel.value === 'hec') {
                hecConfig.style.display = '';
                syslogConfig.style.display = 'none';
                document.getElementById('dest-url').required = true;
                document.getElementById('dest-token').required = true;
                document.getElementById('dest-syslog-ip').required = false;
                document.getElementById('dest-syslog-port').required = false;
            } else {
                hecConfig.style.display = 'none';
                syslogConfig.style.display = '';
                document.getElementById('dest-url').required = false;
                document.getElementById('dest-token').required = false;
                document.getElementById('dest-syslog-ip').required = true;
                document.getElementById('dest-syslog-port').required = true;
            }
        }
        destTypeSel.addEventListener('change', toggleDestConfig);
        toggleDestConfig();
        if (destForm) {
            destForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('dest-name').value.trim();
                const type = destTypeSel.value;
                const storeLocally = document.getElementById('store-token-locally')?.checked;
                
                try {
                    const payload = { type, name };
                    let tokenValue = null;
                    
                    if (type === 'hec') {
                        payload.url = document.getElementById('dest-url').value.trim();
                        tokenValue = document.getElementById('dest-token').value;
                        
                        if (!tokenValue || tokenValue.trim() === '') {
                            alert('Please enter a HEC token');
                            return;
                        }
                        
                        if (storeLocally) {
                            // Store locally - don't send to backend
                            payload.token = 'LOCAL_STORAGE';  // Placeholder for backend
                            console.log('Storing token locally');
                        } else {
                            // Send to backend for database storage
                            payload.token = tokenValue;
                            console.log('Storing token in database');
                        }
                        
                        // Add config settings for parser sync (optional)
                        const configApiUrl = document.getElementById('dest-config-api-url')?.value?.trim();
                        const configReadToken = document.getElementById('dest-config-read-token')?.value?.trim();
                        const configWriteToken = document.getElementById('dest-config-write-token')?.value?.trim();
                        if (configApiUrl) payload.config_api_url = configApiUrl;
                        if (configReadToken) payload.config_read_token = configReadToken;
                        if (configWriteToken) payload.config_write_token = configWriteToken;
                    } else {
                        payload.ip = document.getElementById('dest-syslog-ip').value.trim();
                        payload.port = parseInt(document.getElementById('dest-syslog-port').value, 10);
                        payload.protocol = document.getElementById('dest-syslog-protocol').value;
                    }
                    
                    console.log('Sending payload:', { ...payload, token: payload.token ? '***' : undefined });
                    
                    const r = await fetch('/destinations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!r.ok) {
                        const errorText = await r.text();
                        console.error('Server error:', r.status, errorText);
                        throw new Error(`Failed to save destination (${r.status}): ${errorText}`);
                    }
                    
                    const result = await r.json();
                    const destinationId = result.id;
                    
                    // Store token locally if requested
                    if (type === 'hec' && storeLocally && tokenValue && window.tokenVault) {
                        await window.tokenVault.storeToken(destinationId, tokenValue);
                        console.log(`Token stored locally for destination: ${destinationId}`);
                    }
                    
                    // Clear token fields
                    const tokenEl = document.getElementById('dest-token'); 
                    if (tokenEl) tokenEl.value = '';
                    const configApiUrlEl = document.getElementById('dest-config-api-url');
                    if (configApiUrlEl) configApiUrlEl.value = '';
                    const configReadEl = document.getElementById('dest-config-read-token');
                    if (configReadEl) configReadEl.value = '';
                    const configWriteEl = document.getElementById('dest-config-write-token');
                    if (configWriteEl) configWriteEl.value = '';
                    
                    await refreshDestinations();
                    
                    // Switch to Generate tab to use it
                    const genBtn = document.querySelector('.nav-tab[data-target="generate-section"]');
                    if (genBtn) genBtn.click();
                } catch (err) {
                    alert('Failed to save destination. See console.');
                    console.error(err);
                }
            });
        }
        
        // Clear all tokens button
        const clearAllTokensBtn = document.getElementById('clear-all-tokens-btn');
        if (clearAllTokensBtn) {
            clearAllTokensBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all locally stored tokens? This cannot be undone.')) {
                    window.tokenVault.clearAll();
                    alert('All local tokens have been cleared');
                    refreshDestinations();
                }
            });
        }
        
        // Edit destination modal handlers
        const editModal = document.getElementById('edit-dest-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal');
        const cancelEditModalBtn = document.getElementById('cancel-edit-modal');
        const editDestForm = document.getElementById('edit-dest-form');
        
        function closeEditModal() {
            editModal.style.display = 'none';
        }
        
        closeEditModalBtn?.addEventListener('click', closeEditModal);
        cancelEditModalBtn?.addEventListener('click', closeEditModal);
        editModal?.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
        });
        
        editDestForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const destId = document.getElementById('edit-dest-id').value;
            const name = document.getElementById('edit-dest-name-input').value.trim();
            const url = document.getElementById('edit-dest-url').value.trim();
            const token = document.getElementById('edit-dest-token').value.trim();
            const configApiUrl = document.getElementById('edit-config-api-url').value.trim();
            const configReadToken = document.getElementById('edit-config-read-token').value.trim();
            const configWriteToken = document.getElementById('edit-config-write-token').value.trim();
            
            try {
                const payload = {};
                if (name) payload.name = name;
                if (url) payload.url = url;
                if (token) payload.token = token;
                if (configApiUrl) payload.config_api_url = configApiUrl;
                if (configReadToken) payload.config_read_token = configReadToken;
                if (configWriteToken) payload.config_write_token = configWriteToken;
                
                if (Object.keys(payload).length === 0) {
                    alert('No changes to save');
                    return;
                }
                
                const response = await fetch(`/destinations/${destId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }
                
                alert('‚úì Destination updated successfully');
                closeEditModal();
                await refreshDestinations();
            } catch (err) {
                alert('Failed to update destination. See console.');
                console.error(err);
            }
        });
        
        // Password visibility toggle
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const input = document.getElementById(targetId);
                if (input) {
                    if (input.type === 'password') {
                        input.type = 'text';
                        btn.textContent = 'üîí';
                    } else {
                        input.type = 'password';
                        btn.textContent = 'üëÅ';
                    }
                }
            });
        });
        
        // Handle continuous mode toggle
        const continuousModeCheckbox = document.getElementById('continuous-mode');
        const speedModeContainer = document.getElementById('speed-mode-container');
        const speedModeCheckbox = document.getElementById('speed-mode');
        const logCountInput = document.getElementById('log-count');
        const epsInput = document.getElementById('eps');
        const stopBtn = document.getElementById('stop-btn');
        let currentAbortController = null;

        continuousModeCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                logCountInput.disabled = true;
                logCountInput.required = false;
                logCountInput.style.opacity = '0.5';
                speedModeContainer.style.display = 'flex';
            } else {
                logCountInput.disabled = false;
                logCountInput.required = true;
                logCountInput.style.opacity = '1';
                speedModeContainer.style.display = 'none';
                speedModeCheckbox.checked = false;
            }
        });
        
        // Auto-enable speed mode for high EPS
        epsInput.addEventListener('change', (e) => {
            const eps = parseFloat(e.target.value);
            if (continuousModeCheckbox.checked && eps > 1000) {
                speedModeCheckbox.checked = true;
                speedModeCheckbox.disabled = true;
            } else {
                speedModeCheckbox.disabled = false;
            }
        });

        // Generate metadata GUID button handler
        const genMetadataGuidBtn = document.getElementById('gen-metadata-guid');
        const metadataFieldsInput = document.getElementById('metadata-fields');
        if (genMetadataGuidBtn) {
            genMetadataGuidBtn.addEventListener('click', () => {
                // Generate UUID v4
                const guid = crypto.randomUUID();
                
                // Parse existing metadata or create new
                let metadata = {};
                const currentValue = metadataFieldsInput.value.trim();
                if (currentValue) {
                    try {
                        metadata = JSON.parse(currentValue);
                    } catch (e) {
                        // If parse fails, start fresh
                        metadata = {};
                    }
                }
                
                // Add/update scenario.trace_id
                metadata['scenario.trace_id'] = guid;
                
                // Update input field
                metadataFieldsInput.value = JSON.stringify(metadata);
            });
        }
        
        // Stop button handler
        stopBtn.addEventListener('click', () => {
            if (currentAbortController) {
                currentAbortController.abort();
                outputBox.innerText += '\n\n--- Stopped by user ---\n';
                startBtn.disabled = false;
                startBtn.innerText = 'Start Log Generation';
                stopBtn.style.display = 'none';
                currentAbortController = null;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            startBtn.disabled = true;
            startBtn.innerText = 'Generating...';
            outputBox.innerText = '';
            
            const scriptPath = scriptSelect.value; // for syslog mode
            const productId = scriptSelect.selectedOptions[0]?.dataset?.productId; // for HEC mode
            const logCount = parseInt(document.getElementById('log-count').value, 10);
            const eps = parseFloat(document.getElementById('eps').value);
            const continuousMode = continuousModeCheckbox.checked;
            const speedMode = speedModeCheckbox.checked;
            const selectedOpt = destSelect.options[destSelect.selectedIndex];
            const destinationId = selectedOpt ? selectedOpt.value : '';
            const destinationType = selectedOpt ? selectedOpt.dataset.type : '';
            
            // Parse metadata fields if provided
            const metadataInput = document.getElementById('metadata-fields').value.trim();
            let metadataFields = null;
            if (metadataInput) {
                try {
                    metadataFields = JSON.parse(metadataInput);
                    if (typeof metadataFields !== 'object' || Array.isArray(metadataFields)) {
                        alert('Metadata must be a JSON object (e.g., {"scenario.trace_id":"abc-123"})');
                        startBtn.disabled = false;
                        startBtn.innerText = 'Start Log Generation';
                        return;
                    }
                } catch (e) {
                    alert('Invalid JSON in metadata fields: ' + e.message);
                    startBtn.disabled = false;
                    startBtn.innerText = 'Start Log Generation';
                    return;
                }
            }
            
            const destinationMessage = continuousMode 
              ? `Starting continuous log generation at ${eps} EPS${speedMode ? ' (SPEED MODE)' : ''}...`
              : (destinationType === 'hec'
                  ? `Sending ${logCount} logs to selected HEC destination...`
                  : `Streaming ${logCount} logs to saved syslog destination...`);
            outputBox.innerText = destinationMessage + '\n\n';

            // Show stop button for continuous mode
            if (continuousMode) {
                stopBtn.style.display = 'block';
            }

            try {
                // Create abort controller for stopping
                currentAbortController = new AbortController();
                
                // Get local token if available for HEC destinations
                let localToken = null;
                if (destinationType === 'hec' && window.tokenVault && window.tokenVault.hasToken(destinationId)) {
                    localToken = await window.tokenVault.getToken(destinationId);
                }

                const response = await fetch('/generate-logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: currentAbortController.signal,
                    body: JSON.stringify(destinationType === 'hec' ? {
                        destination: 'hec',
                        product: productId,
                        count: continuousMode ? null : logCount,
                        eps: eps,
                        continuous: continuousMode,
                        speed_mode: speedMode,
                        destination_id: destinationId,
                        hec_token: localToken,  // Pass local token if available
                        metadata: metadataFields  // Pass metadata fields if provided
                    } : {
                        destination: 'syslog',
                        script: scriptPath,
                        count: continuousMode ? null : logCount,
                        eps: eps,
                        continuous: continuousMode,
                        speed_mode: speedMode,
                        destination_id: destinationId,
                        metadata: metadataFields  // Pass metadata fields if provided
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    outputBox.innerText += chunk;
                    outputBox.scrollTop = outputBox.scrollHeight;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Generation stopped by user');
                } else {
                    console.error('Error:', error);
                    outputBox.innerText += `\n--- Generation failed! Error: ${error.message} ---`;
                }
            } finally {
                startBtn.disabled = false;
                startBtn.innerText = 'Start Log Generation';
                stopBtn.style.display = 'none';
                currentAbortController = null;
            }
        });

        // Scenarios functionality
        const scenarioSelect = document.getElementById('scenario-select');
        const scenarioDetails = document.getElementById('scenario-details');
        const scenarioForm = document.getElementById('scenario-form');
        const runScenarioBtn = document.getElementById('run-scenario-btn');
        const scenarioOutputBox = document.getElementById('scenario-output-box');
        let scenariosData = [];

        async function fetchScenarios() {
            try {
                const response = await fetch('/scenarios');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                scenariosData = data.scenarios || [];
                
                scenarioSelect.innerHTML = '';
                if (scenariosData.length === 0) {
                    const opt = document.createElement('option');
                    opt.textContent = 'No scenarios available';
                    opt.disabled = true;
                    scenarioSelect.appendChild(opt);
                } else {
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select a scenario...';
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    scenarioSelect.appendChild(placeholder);
                    
                    scenariosData.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        scenarioSelect.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Error fetching scenarios:', error);
            }
        }

        scenarioSelect.addEventListener('change', () => {
            const selectedId = scenarioSelect.value;
            const scenario = scenariosData.find(s => s.id === selectedId);
            if (scenario) {
                document.getElementById('scenario-name').textContent = scenario.name;
                document.getElementById('scenario-description').textContent = scenario.description;
                document.getElementById('scenario-events').textContent = scenario.total_events;
                
                let duration = '';
                if (scenario.duration_days) {
                    duration = `${scenario.duration_days} days`;
                } else if (scenario.duration_minutes) {
                    duration = `${scenario.duration_minutes} minutes`;
                }
                document.getElementById('scenario-duration').textContent = duration;
                
                const phasesList = document.getElementById('scenario-phases');
                phasesList.innerHTML = '';
                (scenario.phases || []).forEach(phase => {
                    const li = document.createElement('li');
                    li.textContent = phase;
                    phasesList.appendChild(li);
                });
                
                scenarioDetails.style.display = '';
            } else {
                scenarioDetails.style.display = 'none';
            }
        });

        // Generate Trace ID button for scenarios
        const genTraceIdBtnScenario = document.getElementById('gen-trace-id');
        const traceIdInput = document.getElementById('trace-id');
        
        if (genTraceIdBtnScenario && traceIdInput) {
            genTraceIdBtnScenario.addEventListener('click', () => {
                const guid = crypto.randomUUID();
                traceIdInput.value = guid;
            });
        }
        
        scenarioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedId = scenarioSelect.value;
            if (!selectedId) return;
            
            const selectedOpt = destSelect.options[destSelect.selectedIndex];
            const destinationId = selectedOpt ? selectedOpt.value : '';
            const workerCount = parseInt(document.getElementById('worker-count').value, 10);
            
            if (!destinationId) {
                alert('Please select a destination in the sidebar.');
                return;
            }
            
            runScenarioBtn.disabled = true;
            runScenarioBtn.innerText = 'Running Scenario...';
            scenarioOutputBox.innerText = '';
            
            try {
                // Metadata options
                const tagPhase = document.getElementById('include-phase-tag')?.checked !== false;
                const tagTrace = document.getElementById('include-trace-id')?.checked !== false;
                let traceId = (document.getElementById('trace-id')?.value || '').trim();
                // Auto-generate a GUID if tagging is enabled and no trace id provided
                if (tagTrace && !traceId) {
                    traceId = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                    );
                    const traceInput = document.getElementById('trace-id');
                    if (traceInput) traceInput.value = traceId;
                }
                // Background noise options
                const generateNoise = document.getElementById('generate-noise')?.checked || false;
                const noiseEventsCount = parseInt(document.getElementById('noise-events-count')?.value || '1200', 10);
                
                // Get local token if available
                let localToken = null;
                if (window.tokenVault && window.tokenVault.hasToken(destinationId)) {
                    localToken = await window.tokenVault.getToken(destinationId);
                }
                
                const response = await fetch('/scenarios/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scenario_id: selectedId,
                        destination_id: destinationId,
                        workers: workerCount,
                        tag_phase: tagPhase,
                        tag_trace: tagTrace,
                        trace_id: traceId,
                        generate_noise: generateNoise,
                        noise_events_count: noiseEventsCount,
                        hec_token: localToken  // Pass local token if available
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    scenarioOutputBox.innerText += chunk;
                    scenarioOutputBox.scrollTop = scenarioOutputBox.scrollHeight;
                }
            } catch (error) {
                console.error('Error:', error);
                scenarioOutputBox.innerText += `\n--- Scenario execution failed! Error: ${error.message} ---`;
            } finally {
                runScenarioBtn.disabled = false;
                runScenarioBtn.innerText = 'Run Scenario';
            }
        });

        fetchScenarios();

        // ===== TRACE ID GENERATOR ===== 
        // (Already handled above to avoid duplicate event listeners)

        // ===== FILE UPLOAD FUNCTIONALITY =====
        const uploadDropzone = document.getElementById('upload-dropzone');
        const fileInput = document.getElementById('file-input');
        const uploadFileSelect = document.getElementById('upload-file-select');
        const uploadProcessForm = document.getElementById('upload-process-form');
        const processUploadBtn = document.getElementById('process-upload-btn');
        const uploadOutputBox = document.getElementById('upload-output-box');
        const uploadedFilesList = document.getElementById('uploaded-files-list');
        const filesContainer = document.getElementById('files-container');

        // Drag and drop functionality
        uploadDropzone.addEventListener('click', () => {
            fileInput.click();
        });

        uploadDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropzone.style.borderColor = '#a78bfa';
            uploadDropzone.style.backgroundColor = 'rgba(167, 139, 250, 0.05)';
        });

        uploadDropzone.addEventListener('dragleave', () => {
            uploadDropzone.style.borderColor = '#8b5cf6';
            uploadDropzone.style.backgroundColor = 'transparent';
        });

        uploadDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropzone.style.borderColor = '#8b5cf6';
            uploadDropzone.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            // Validate file type
            const validTypes = ['.csv', '.json', '.txt', '.log', '.gz'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!validTypes.includes(fileExt)) {
                alert('Invalid file type. Allowed: CSV, JSON, TXT, LOG, GZ');
                return;
            }

            // Validate file size (1GB)
            const maxSize = 1 * 1024 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('File size exceeds 1GB limit.');
                return;
            }

            uploadOutputBox.innerText = `Uploading ${file.name} (${(file.size / (1024*1024)).toFixed(2)} MB)...\n`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/uploads', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }

                const result = await response.json();
                uploadOutputBox.innerText += `‚úì Successfully uploaded ${result.filename}\n`;
                uploadOutputBox.innerText += `  File ID: ${result.id}\n`;
                uploadOutputBox.innerText += `  Records: ${result.line_count || 'Unknown'}\n`;
                
                // Refresh uploads list
                await refreshUploads();
                
                // Reset file input
                fileInput.value = '';
            } catch (error) {
                console.error('Upload error:', error);
                uploadOutputBox.innerText += `‚úó Upload failed: ${error.message}\n`;
            }
        }

        async function refreshUploads() {
            try {
                const response = await fetch('/uploads');
                if (!response.ok) throw new Error('Failed to fetch uploads');
                
                const data = await response.json();
                const uploads = data.uploads || [];

                // Update file select dropdown
                uploadFileSelect.innerHTML = '';
                if (uploads.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No files uploaded';
                    opt.disabled = true;
                    opt.selected = true;
                    uploadFileSelect.appendChild(opt);
                    uploadedFilesList.style.display = 'none';
                } else {
                    uploads.forEach(upload => {
                        const opt = document.createElement('option');
                        opt.value = upload.id;
                        opt.textContent = `${upload.filename} (${upload.line_count || '?'} records, ${(upload.size / (1024*1024)).toFixed(2)} MB)`;
                        uploadFileSelect.appendChild(opt);
                    });
                    
                    // Show uploaded files list
                    uploadedFilesList.style.display = '';
                    filesContainer.innerHTML = '';
                    uploads.forEach(upload => {
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'card p-2 flex items-center justify-between gap-2';
                        fileDiv.innerHTML = `
                            <span class="text-xs truncate" style="color: #f3e8ff;">${upload.filename}</span>
                            <button type="button" class="delete-upload-btn" data-id="${upload.id}" style="background: transparent; border: none; padding: 4px; cursor: pointer; color: #f3e8ff;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6" />
                                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                </svg>
                            </button>
                        `;
                        filesContainer.appendChild(fileDiv);
                    });

                    // Add delete handlers
                    document.querySelectorAll('.delete-upload-btn').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const uploadId = btn.dataset.id;
                            if (!confirm('Delete this file?')) return;
                            
                            try {
                                const resp = await fetch(`/uploads/${uploadId}`, { method: 'DELETE' });
                                if (resp.status === 204) {
                                    await refreshUploads();
                                    uploadOutputBox.innerText += `‚úì Deleted file\n`;
                                } else {
                                    throw new Error('Delete failed');
                                }
                            } catch (error) {
                                alert('Failed to delete file');
                                console.error(error);
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Failed to refresh uploads:', error);
            }
        }

        // Process uploaded file
        uploadProcessForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const uploadId = uploadFileSelect.value;
            const destinationId = destSelect.value;
            const batchSize = parseInt(document.getElementById('upload-batch-size').value, 10);
            const eps = parseFloat(document.getElementById('upload-eps').value);
            const sourcetype = document.getElementById('upload-sourcetype').value.trim();
            const endpoint = document.getElementById('upload-endpoint').value;

            if (!uploadId || !destinationId) {
                alert('Please select both a file and a destination');
                return;
            }

            if (!sourcetype) {
                alert('Please specify a sourcetype');
                return;
            }

            processUploadBtn.disabled = true;
            processUploadBtn.innerText = 'Processing...';
            uploadOutputBox.innerText = 'Starting file processing...\n\n';

            try {
                // Get local token if available
                let localToken = null;
                if (window.tokenVault && window.tokenVault.hasToken(destinationId)) {
                    localToken = await window.tokenVault.getToken(destinationId);
                }
                
                const response = await fetch('/uploads/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        upload_id: uploadId,
                        destination_id: destinationId,
                        batch_size: batchSize,
                        eps: eps,
                        sourcetype: sourcetype,
                        endpoint: endpoint,
                        hec_token: localToken  // Pass local token if available
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    uploadOutputBox.innerText += chunk;
                    uploadOutputBox.scrollTop = uploadOutputBox.scrollHeight;
                }
            } catch (error) {
                console.error('Processing error:', error);
                uploadOutputBox.innerText += `\n‚úó Processing failed: ${error.message}\n`;
            } finally {
                processUploadBtn.disabled = false;
                processUploadBtn.innerText = 'Process File';
            }
        });

        // Initialize uploads list
        refreshUploads();

        })();
    });
</script>

</body>
</html>
